<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coze-like Demo (Single HTML, White Theme)</title>
  <style>
    :root{
      --bg:#ffffff;
      --bg2:#f6f7fb;
      --panel:#ffffff;
      --panel2:#fbfcff;
      --line:#e7e9f1;
      --line2:#dfe3ee;
      --text:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;
      --accent:#5b5cf6;
      --accent2:#4f46e5;
      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#ef4444;
      --shadow: 0 14px 34px rgba(15,23,42,.10);
      --shadow2: 0 6px 18px rgba(15,23,42,.08);
      --radius: 14px;
      --radius2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    button, input, select, textarea{ font:inherit; }
    a{ color:inherit; text-decoration:none; }

    /* App shell */
    .app{ height:100%; display:flex; flex-direction:column; }

    /* Top bar (match screenshot vibe) */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #fff, #fafbff);
      position:sticky; top:0; z-index:50;
    }
    .top-left{
      display:flex; align-items:center; gap:12px;
      min-width: 380px;
    }
    .logo{
      width:28px;height:28px;border-radius:10px;
      background:linear-gradient(135deg, rgba(91,92,246,.18), rgba(79,70,229,.10));
      border:1px solid rgba(91,92,246,.35);
      display:flex;align-items:center;justify-content:center;
      color:var(--accent2);
      font-weight:900;
      flex:0 0 auto;
    }
    .brand{
      display:flex; flex-direction:column; line-height:1.1;
      min-width: 220px;
    }
    .brand .t{ font-weight:800; letter-spacing:.2px; }
    .brand .s{ font-size:12px; color:var(--muted); font-weight:600; }

    .pill{
      font-size:12px;
      color:var(--muted);
      padding:4px 10px;
      border:1px solid var(--line2);
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
    }

    .top-mid{
      display:flex; align-items:center; gap:8px;
    }
    .tab{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid transparent;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-weight:650;
    }
    .tab:hover{ background:#f6f7ff; color: var(--text); }
    .tab.active{
      background:rgba(91,92,246,.10);
      border-color: rgba(91,92,246,.30);
      color: var(--accent2);
    }

    .top-actions{
      display:flex; align-items:center; gap:10px;
      min-width: 320px;
      justify-content:flex-end;
    }
    .btn{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:#fff;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .btn:hover{ background:#f8f9ff; }
    .btn.primary{
      background:rgba(91,92,246,.10);
      border-color: rgba(91,92,246,.35);
      color: var(--accent2);
    }
    .btn.primary:hover{ background:rgba(91,92,246,.14); }
    .btn.green{
      background:rgba(22,163,74,.10);
      border-color: rgba(22,163,74,.30);
      color: #166534;
    }
    .btn.green:hover{ background:rgba(22,163,74,.14); }
    .btn.ghost{
      background:transparent;
      border-color:transparent;
    }
    .btn.ghost:hover{
      background:#f4f6ff;
      border-color:var(--line);
    }

    /* Pages container */
    .pages{ flex:1; min-height:0; position:relative; }
    .page{ position:absolute; inset:0; display:none; }
    .page.active{ display:flex; }

    /* ========= Agent Page Layout (match screenshot: left config, mid editor, right debug) ========= */
    .agent{
      flex:1; min-height:0;
      display:flex;
      background: var(--bg);
    }
    .agent-left{
      width:320px;
      border-right:1px solid var(--line);
      background: var(--panel2);
      padding:12px;
      overflow:auto;
    }
    .agent-mid{
      flex:1; min-width:0;
      padding:12px;
      overflow:auto;
      background: var(--bg);
    }
    .agent-right{
      width:420px;
      border-left:1px solid var(--line);
      background: var(--panel2);
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .section-title{
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .kbd{
      font-size:11px; color:var(--muted);
      border:1px solid var(--line2);
      padding:2px 7px;
      border-radius:10px;
      background:#fff;
      white-space:nowrap;
    }
    .card{
      border:1px solid var(--line2);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow2);
      padding:12px;
    }
    .card + .card{ margin-top:12px; }
    .card h3{
      margin:0 0 10px 0;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    /* Left collapsible config list */
    .acc{
      display:flex; flex-direction:column; gap:10px;
    }
    .acc-item{
      border:1px solid var(--line2);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .acc-head{
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .acc-head .left{
      display:flex; flex-direction:column; gap:2px;
    }
    .acc-head .t{ font-weight:800; font-size:13px; }
    .acc-head .s{ font-size:12px; color:var(--muted); }
    .acc-head .chev{ color:var(--muted); font-size:12px; }
    .acc-body{
      border-top:1px solid var(--line);
      padding:12px;
      display:none;
      background: linear-gradient(180deg, #fff, #fcfcff);
    }
    .acc-item.open .acc-body{ display:block; }
    .acc-row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:#fff;
      font-size:12px;
      color: var(--muted);
    }

    /* Mid editor fields */
    .field{ display:flex; flex-direction:column; gap:6px; margin-top:12px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input, .field select, .field textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line2);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .field textarea{ min-height:110px; resize:vertical; }
    .help{
      font-size:12px; color:var(--muted); line-height:1.5;
      margin-top:8px;
    }

    /* Right chat debug */
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      border:1px solid var(--line2);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-height:0;
    }
    .chat-head{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, #fff, #fbfbff);
    }
    .chat-title{ font-weight:850; font-size:13px; }
    .chat-body{
      flex:1; min-height:0;
      padding:12px;
      overflow:auto;
      background:#fff;
    }
    .msg{
      max-width: 88%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background:#fff;
      box-shadow: var(--shadow2);
      margin-bottom:10px;
      font-size:13px;
      line-height:1.55;
      color: rgba(15,23,42,.92);
      white-space:pre-wrap;
    }
    .msg.user{
      margin-left:auto;
      border-color: rgba(91,92,246,.25);
      background: rgba(91,92,246,.06);
    }
    .msg.assistant{ margin-right:auto; }
    .chat-input{
      display:flex; gap:10px;
      padding:10px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .chat-input input{
      flex:1;
      border-radius: 14px;
      border:1px solid var(--line2);
      padding:10px 12px;
      outline:none;
      background:#fff;
    }

    /* ========= Workflow Page (nodes deletable) ========= */
    .wf{
      flex:1; min-height:0;
      display:flex;
      background: var(--bg);
    }
    .wf-left{
      width:260px;
      border-right:1px solid var(--line);
      background: var(--panel2);
      padding:12px;
      overflow:auto;
    }
    .wf-center{
      flex:1; min-width:0;
      position:relative; overflow:hidden;
      background: var(--bg);
    }
    .wf-right{
      width:340px;
      border-left:1px solid var(--line);
      background: var(--panel2);
      padding:12px;
      overflow:auto;
    }

    .node-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .node-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line2);
      background:#fff;
      cursor:grab;
      user-select:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: var(--shadow2);
    }
    .node-item:active{ cursor:grabbing; }
    .node-item .meta{ display:flex; flex-direction:column; gap:2px; }
    .node-item .name{ font-weight:800; font-size:13px; }
    .node-item .desc{ font-size:12px; color:var(--muted); }

    .canvas-wrap{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 1px 1px, rgba(15,23,42,.10) 1px, transparent 1px) 0 0 / 22px 22px,
        linear-gradient(180deg, rgba(91,92,246,.06), rgba(255,255,255,0));
    }
    .world{
      position:absolute; left:0; top:0;
      width:100%; height:100%;
      transform-origin:0 0;
      will-change:transform;
    }
    svg.edges{ position:absolute; inset:0; overflow:visible; pointer-events:none; }
    .nodes-layer{ position:absolute; inset:0; }

    .toast{
      position:absolute; left:50%; top:12px; transform:translateX(-50%);
      padding:8px 12px; border-radius:12px;
      background:#fff;
      border:1px solid var(--line2);
      box-shadow: var(--shadow2);
      color: rgba(15,23,42,.85);
      font-size:12px;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      z-index:50;
    }
    .toast.show{ opacity:1; }

    .node{
      position:absolute;
      width:230px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background:#fff;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .node.selected{ outline:2px solid rgba(91,92,246,.55); outline-offset:2px; }
    .node-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px 6px 10px;
      gap:10px;
    }
    .node-title{
      display:flex; align-items:center; gap:8px;
      font-weight:850; font-size:13px;
      min-width: 0;
    }
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      color: var(--muted);
      background:#fff;
      flex:0 0 auto;
    }
    .title-text{
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .node-actions{
      display:flex; align-items:center; gap:6px;
      flex:0 0 auto;
    }
    .iconbtn{
      width:28px; height:28px;
      border-radius:10px;
      border:1px solid var(--line2);
      background:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      color: var(--muted);
    }
    .iconbtn:hover{ background:#f6f7ff; color: var(--text); }
    .iconbtn.danger:hover{ background: rgba(239,68,68,.08); color:#991b1b; border-color: rgba(239,68,68,.25); }

    .run-badge{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line2);
      background:#fff;
      color: var(--muted);
    }
    .run-badge.running{ border-color: rgba(91,92,246,.35); color: var(--accent2); background: rgba(91,92,246,.08); }
    .run-badge.success{ border-color: rgba(22,163,74,.30); color:#166534; background: rgba(22,163,74,.08); }
    .run-badge.error{ border-color: rgba(239,68,68,.30); color:#991b1b; background: rgba(239,68,68,.08); }

    .node-body{ padding: 0 10px 10px 10px; display:flex; gap:10px; }
    .io-col{ flex:1; display:flex; flex-direction:column; gap:6px; }
    .io-label{
      font-size:12px; color:var(--muted);
      display:flex; align-items:center; justify-content:space-between;
    }
    .io-pill{
      font-size:11px;
      color: rgba(15,23,42,.85);
      padding:7px 8px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:#fff;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .port{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(91,92,246,.45);
      background: rgba(91,92,246,.20);
      flex:0 0 auto;
    }
    .port.in{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.18);
    }
    .port.out{
      border-color: rgba(91,92,246,.45);
      background: rgba(91,92,246,.20);
    }
    .port.hit{ outline:3px solid rgba(15,23,42,.10); outline-offset:2px; }

    .edge-path{
      stroke: rgba(91,92,246,.85);
      stroke-width: 2.2;
      fill:none;
      filter: drop-shadow(0 6px 10px rgba(15,23,42,.10));
    }
    .edge-path.ok{ stroke: rgba(22,163,74,.65); }
    .edge-path.preview{ stroke-dasharray: 6 6; stroke: rgba(15,23,42,.35); }

    .bottom{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex; align-items:center; justify-content:space-between;
      pointer-events:none;
      z-index:20;
    }
    .toolbar{ display:flex; align-items:center; gap:10px; pointer-events:auto; }
    .zoom{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line2);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .zoom .pct{ width:52px; text-align:center; color:rgba(15,23,42,.82); font-size:12px; }
    .hint{
      font-size:12px; color:var(--muted);
      padding:8px 10px;
      border:1px solid var(--line2);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow2);
      max-width: 70ch;
    }
    .log{
      font-family:var(--mono);
      font-size:12px;
      color: rgba(15,23,42,.75);
      white-space: pre-wrap;
      line-height:1.45;
      max-height: 260px;
      overflow:auto;
      border:1px solid var(--line2);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }

    /* ========= Knowledge Base (RAG) Page (simple upload) ========= */
    .kb{
      flex:1; min-height:0;
      display:flex;
      background: var(--bg);
    }
    .kb-left{
      width:320px;
      border-right:1px solid var(--line);
      background: var(--panel2);
      padding:12px;
      overflow:auto;
    }
    .kb-mid{
      flex:1; min-width:0;
      padding:12px;
      overflow:auto;
      background: var(--bg);
    }
    .kb-right{
      width:420px;
      border-left:1px solid var(--line);
      background: var(--panel2);
      padding:12px;
      overflow:auto;
    }

    .drop{
      border:1.5px dashed rgba(91,92,246,.35);
      border-radius: var(--radius);
      background: rgba(91,92,246,.04);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .drop strong{ color: var(--accent2); }
    .filelist{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .fileitem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line2);
      background:#fff;
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .filemeta{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .filemeta .n{ font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .filemeta .d{ font-size:12px; color:var(--muted); }
    .small{
      font-size:12px; color:var(--muted); line-height:1.5;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .sep{ height:1px; background:var(--line); margin:12px 0; }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="top-left">
      <div class="logo">C</div>
      <div class="brand">
        <div class="t">Coze-like å‰ç«¯ Demoï¼ˆå•æ–‡ä»¶ï¼‰</div>
        <div class="s">å·¥ä½œæµ / Agent ç¼–è¾‘ / çŸ¥è¯†åº“ï¼ˆç™½è‰²ä¸»é¢˜ï¼‰</div>
      </div>
      <span class="pill" id="globalStatus">è‰ç¨¿å·²ä¿å­˜</span>
    </div>

    <div class="top-mid" id="tabs">
      <div class="tab active" data-page="agent">Agent ç¼–è¾‘</div>
      <div class="tab" data-page="workflow">å·¥ä½œæµè®¾è®¡</div>
      <div class="tab" data-page="kb">çŸ¥è¯†åº“ï¼ˆRAGï¼‰</div>
    </div>

    <div class="top-actions">
      <button class="btn ghost" id="btnReset">é‡ç½® Demo</button>
      <button class="btn primary" id="btnPublish">å‘å¸ƒï¼ˆDemoï¼‰</button>
      <button class="btn green" id="btnRun">è¯•è¿è¡Œ</button>
    </div>
  </div>

  <div class="pages">
    <!-- ===================== Agent Page ===================== -->
    <div class="page active" id="page-agent">
      <div class="agent">
        <!-- Left: Custom configuration -->
        <div class="agent-left">
          <div class="section-title">
            <span>äººè®¾ä¸å›å¤é€»è¾‘</span>
            <span class="kbd">æµ‹è¯•</span>
          </div>

          <div class="acc" id="acc">
            <div class="acc-item open" data-key="model">
              <div class="acc-head">
                <div class="left">
                  <div class="t">æ¨¡å‹è®¾ç½®</div>
                  <div class="s">æ¨¡å‹ã€æ¸©åº¦ã€ä¸Šä¸‹æ–‡ç­‰</div>
                </div>
                <div class="chev">â–¾</div>
              </div>
              <div class="acc-body">
                <div class="field" style="margin-top:0">
                  <label>æ¨¡å‹</label>
                  <select id="agentModel">
                    <option value="gpt-4.1-mini" selected>gpt-4.1-mini</option>
                    <option value="gpt-4.1">gpt-4.1</option>
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-4o">gpt-4o</option>
                  </select>
                </div>
                <div class="field">
                  <label>æ¸©åº¦ï¼ˆDemoï¼‰</label>
                  <input id="agentTemp" type="number" min="0" max="2" step="0.1" value="0.7" />
                </div>
                <div class="small" style="margin-top:8px">
                  Demo ä¸åšçœŸå®æ¨ç†ï¼Œä»…å±•ç¤ºé…ç½®å…¥å£ã€‚
                </div>
              </div>
            </div>

            <div class="acc-item" data-key="skills">
              <div class="acc-head">
                <div class="left">
                  <div class="t">æŠ€èƒ½</div>
                  <div class="s">æ’ä»¶ / å·¥ä½œæµ / å·¥å…·è°ƒç”¨</div>
                </div>
                <div class="chev">â–¸</div>
              </div>
              <div class="acc-body">
                <div class="small">è¿™é‡Œåªåšâ€œæ¥å…¥å·¥ä½œæµâ€çš„é€‰æ‹©ä¸å¼€å…³æ¼”ç¤ºã€‚</div>
                <div class="field">
                  <label>å¯ç”¨å·¥ä½œæµ</label>
                  <select id="useWorkflow">
                    <option value="on" selected>å¼€å¯</option>
                    <option value="off">å…³é—­</option>
                  </select>
                </div>
                <div class="field">
                  <label>é€‰æ‹©å·¥ä½œæµ</label>
                  <select id="workflowSelect">
                    <option value="workflow_demo" selected>workflow_demo</option>
                    <option value="order_assistant">order_assistant</option>
                    <option value="faq_router">faq_router</option>
                  </select>
                </div>
                <div class="row" style="margin-top:10px">
                  <button class="btn" id="btnOpenWorkflowFromAgent">æ‰“å¼€å·¥ä½œæµè®¾è®¡</button>
                </div>
              </div>
            </div>

            <div class="acc-item" data-key="knowledge">
              <div class="acc-head">
                <div class="left">
                  <div class="t">çŸ¥è¯†</div>
                  <div class="s">æ¥å…¥çŸ¥è¯†åº“ï¼ˆRAGï¼‰</div>
                </div>
                <div class="chev">â–¸</div>
              </div>
              <div class="acc-body">
                <div class="small">è¿™é‡Œåªåšâ€œé€‰æ‹©çŸ¥è¯†åº“ + æ˜¯å¦å¯ç”¨æ£€ç´¢â€çš„æ¼”ç¤ºã€‚</div>
                <div class="field">
                  <label>å¯ç”¨çŸ¥è¯†åº“æ£€ç´¢</label>
                  <select id="useKb">
                    <option value="on" selected>å¼€å¯</option>
                    <option value="off">å…³é—­</option>
                  </select>
                </div>
                <div class="field">
                  <label>é€‰æ‹©çŸ¥è¯†åº“</label>
                  <select id="kbSelect">
                    <option value="kb_demo" selected>kb_demo</option>
                    <option value="product_docs">product_docs</option>
                    <option value="policy_docs">policy_docs</option>
                  </select>
                </div>
                <div class="row" style="margin-top:10px">
                  <button class="btn" id="btnOpenKbFromAgent">åˆ›å»º/ç®¡ç†çŸ¥è¯†åº“</button>
                </div>
              </div>
            </div>

            <div class="acc-item" data-key="memory">
              <div class="acc-head">
                <div class="left">
                  <div class="t">è®°å¿†</div>
                  <div class="s">å˜é‡ / é•¿æœŸè®°å¿†ï¼ˆDemoï¼‰</div>
                </div>
                <div class="chev">â–¸</div>
              </div>
              <div class="acc-body">
                <div class="row">
                  <span class="chip">sys_images</span>
                  <span class="chip">input_text</span>
                  <span class="chip">llm_output</span>
                </div>
                <div class="small" style="margin-top:8px">
                  Demo ä¸åšæŒä¹…åŒ–ï¼Œä»…å±•ç¤º UIã€‚
                </div>
              </div>
            </div>

            <div class="acc-item" data-key="experience">
              <div class="acc-head">
                <div class="left">
                  <div class="t">å¯¹è¯ä½“éªŒ</div>
                  <div class="s">å¼€åœºç™½ / å¿«æ·æŒ‡ä»¤ï¼ˆDemoï¼‰</div>
                </div>
                <div class="chev">â–¸</div>
              </div>
              <div class="acc-body">
                <div class="field" style="margin-top:0">
                  <label>å¼€åœºç™½</label>
                  <input id="agentHello" value="ä½ å¥½ï¼Œæˆ‘å¯ä»¥å¸®ä½ è¿æ¥å·¥ä½œæµä¸çŸ¥è¯†åº“ï¼Œå¹¶åœ¨å³ä¾§è°ƒè¯•å¯¹è¯ã€‚" />
                </div>
                <div class="field">
                  <label>å¿«æ·æŒ‡ä»¤ï¼ˆDemoï¼‰</label>
                  <div class="row">
                    <span class="chip">/help</span>
                    <span class="chip">/run_workflow</span>
                    <span class="chip">/rag</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>å¸¸ç”¨æ¨¡æ¿ï¼ˆDemoï¼‰</h3>
            <div class="row">
              <span class="chip">é€šç”¨ç»“æ„</span>
              <span class="chip">ä»»åŠ¡æ‰§è¡Œ</span>
              <span class="chip">è§’è‰²æ‰®æ¼”</span>
            </div>
            <div class="small" style="margin-top:10px">
              ä»…ç”¨äºå±•ç¤ºå¸ƒå±€ï¼Œä¸å«çœŸå®æ¨¡æ¿åº“ã€‚
            </div>
          </div>
        </div>

        <!-- Middle: Editor (only workflow + KB chips needed) -->
        <div class="agent-mid">
          <div class="card">
            <h3>ç¼–è¾‘</h3>

            <div class="field" style="margin-top:0">
              <label>System Promptï¼ˆäººè®¾/è§„åˆ™ï¼‰</label>
              <textarea id="agentSystem">ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„åŠ©ç†ã€‚å›ç­”è¦ç»“æ„æ¸…æ™°ã€å¯æ‰§è¡Œã€‚</textarea>
            </div>

            <div class="field">
              <label>æ¥å…¥èƒ½åŠ›ï¼ˆDemoï¼‰</label>
              <div class="row">
                <span class="chip">å·¥ä½œæµï¼š<b id="chipWorkflow">workflow_demo</b></span>
                <span class="chip">çŸ¥è¯†åº“ï¼š<b id="chipKb">kb_demo</b></span>
                <span class="chip">æ£€ç´¢ï¼š<b id="chipKbOn">ON</b></span>
              </div>
              <div class="help">
                è¿™å—åªä¿ç•™ä½ è¦çš„æ ¸å¿ƒï¼šä¸­é—´æ”¯æŒæ¥å…¥â€œå·¥ä½œæµ + çŸ¥è¯†åº“â€ã€‚ï¼ˆä¸å±•ç¤ºåˆ†æ®µ/å¬å›ç»†èŠ‚ï¼‰
              </div>
            </div>

            <div class="field">
              <label>å·¥å…·è¡Œä¸ºï¼ˆDemoï¼‰</label>
              <textarea id="agentToolPolicy" placeholder="ä¾‹å¦‚ï¼šä»€ä¹ˆæ—¶å€™è°ƒç”¨å·¥ä½œæµï¼Œä»€ä¹ˆæ—¶å€™èµ°RAG...">å½“ç”¨æˆ·è¯·æ±‚ç»“æ„åŒ–ä»»åŠ¡æ—¶ä¼˜å…ˆè°ƒç”¨å·¥ä½œæµï¼›å½“ç”¨æˆ·è¯¢é—®èµ„æ–™æ—¶ä¼˜å…ˆä½¿ç”¨çŸ¥è¯†åº“æ£€ç´¢ã€‚</textarea>
            </div>

            <div class="row" style="margin-top:14px">
              <button class="btn primary" id="btnSaveAgent">ä¿å­˜ï¼ˆDemoï¼‰</button>
              <button class="btn" id="btnSendHello">å‘é€å¼€åœºç™½åˆ°å³ä¾§</button>
            </div>
          </div>

          <div class="card">
            <h3>è¯´æ˜</h3>
            <div class="small">
              ä½ ä¸Šä¼ çš„å¸ƒå±€é‡Œï¼šå·¦ä¾§æ˜¯å¯å±•å¼€é…ç½®ï¼Œä¸­é—´æ˜¯ç¼–è¾‘åŒºï¼Œå³ä¾§æ˜¯é¢„è§ˆä¸è°ƒè¯•ã€‚è¿™é‡ŒæŒ‰è¯¥ç»“æ„å¤åˆ»ã€‚
            </div>
          </div>
        </div>

        <!-- Right: Debug Chat -->
        <div class="agent-right">
          <div class="chat">
            <div class="chat-head">
              <div class="chat-title">é¢„è§ˆä¸è°ƒè¯•</div>
              <div style="display:flex; gap:8px;">
                <button class="btn" id="btnClearChat">æ¸…ç©º</button>
                <button class="btn green" id="btnQuickRun">è¯•è¿è¡Œ</button>
              </div>
            </div>
            <div class="chat-body" id="chatBody"></div>
            <div class="chat-input">
              <input id="chatInput" placeholder="å‘é€æ¶ˆæ¯..." />
              <button class="btn primary" id="btnSend">å‘é€</button>
            </div>
          </div>
          <div class="small" style="margin-top:10px">
            Demo å›å¤ä¸ºæœ¬åœ°æ¨¡æ‹Ÿï¼šä¼šæ ¹æ®â€œæ˜¯å¦å¯ç”¨å·¥ä½œæµ/çŸ¥è¯†åº“â€æ‹¼æ¥æç¤ºï¼Œä¸åšçœŸå®æ¨ç†ã€‚
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== Workflow Page ===================== -->
    <div class="page" id="page-workflow">
      <div class="wf">
        <div class="wf-left">
          <div class="section-title">
            <span>èŠ‚ç‚¹åº“ï¼ˆæ‹–åˆ°ç”»å¸ƒï¼‰</span>
            <span class="kbd">æ‹–æ‹½</span>
          </div>
          <div class="node-list" id="wfPalette">
            <div class="node-item" draggable="true" data-type="start">
              <div class="meta">
                <div class="name">å¼€å§‹</div>
                <div class="desc">æµç¨‹å…¥å£</div>
              </div>
              <div class="kbd">Start</div>
            </div>
            <div class="node-item" draggable="true" data-type="wait">
              <div class="meta">
                <div class="name">time_wait</div>
                <div class="desc">å»¶æ—¶ç­‰å¾…</div>
              </div>
              <div class="kbd">Wait</div>
            </div>
            <div class="node-item" draggable="true" data-type="llm">
              <div class="meta">
                <div class="name">å¤§æ¨¡å‹</div>
                <div class="desc">LLM è°ƒç”¨</div>
              </div>
              <div class="kbd">LLM</div>
            </div>
            <div class="node-item" draggable="true" data-type="end">
              <div class="meta">
                <div class="name">ç»“æŸ</div>
                <div class="desc">æµç¨‹å‡ºå£</div>
              </div>
              <div class="kbd">End</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>æ“ä½œ</h3>
            <div class="small">
              <div><span class="kbd">æ»šè½®</span> ç¼©æ”¾ã€€<span class="kbd">ç©ºç™½æ‹–æ‹½</span> å¹³ç§»</div>
              <div style="margin-top:6px"><span class="kbd">æ‹–ç«¯å£</span> è¾“å‡ºâ†’è¾“å…¥ è¿çº¿</div>
              <div style="margin-top:6px"><span class="kbd">Delete</span> åˆ é™¤é€‰ä¸­èŠ‚ç‚¹ æˆ– ç‚¹å‡»èŠ‚ç‚¹å³ä¸Šè§’ ğŸ—‘</div>
            </div>
          </div>
        </div>

        <div class="wf-center" id="wfCenter">
          <div class="canvas-wrap" id="wfCanvasWrap">
            <div class="toast" id="wfToast"></div>

            <div class="world" id="wfWorld">
              <svg class="edges" id="wfEdgesSvg">
                <path id="wfPreviewPath" class="edge-path preview" d=""></path>
              </svg>
              <div class="nodes-layer" id="wfNodesLayer"></div>
            </div>

            <div class="bottom">
              <div class="toolbar">
                <div class="zoom">
                  <button class="btn" id="wfZoomOut">ï¼</button>
                  <div class="pct" id="wfZoomPct">100%</div>
                  <button class="btn" id="wfZoomIn">ï¼‹</button>
                </div>
                <button class="btn" id="wfFit">é€‚é…è§†å›¾</button>
              </div>
              <div class="toolbar">
                <button class="btn" id="wfAddNode">+ æ·»åŠ èŠ‚ç‚¹</button>
                <div class="hint">Demoï¼šèŠ‚ç‚¹å¯åˆ é™¤ï¼ˆå³ä¸Šè§’ ğŸ—‘ / Deleteï¼‰</div>
              </div>
            </div>
          </div>
        </div>

        <div class="wf-right">
          <div class="card">
            <h3>èŠ‚ç‚¹é…ç½® <span class="kbd" id="wfSelId">æœªé€‰ä¸­</span></h3>
            <div id="wfInspectorBody" class="small">ç‚¹å‡»ç”»å¸ƒèŠ‚ç‚¹æŸ¥çœ‹/ç¼–è¾‘å‚æ•°ã€‚</div>
          </div>

          <div class="card">
            <h3>è¿è¡Œæ—¥å¿—ï¼ˆDemoï¼‰</h3>
            <div class="log" id="wfRunLog"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== KB Page (RAG) ===================== -->
    <div class="page" id="page-kb">
      <div class="kb">
        <div class="kb-left">
          <div class="card">
            <h3>çŸ¥è¯†åº“åˆ—è¡¨ï¼ˆDemoï¼‰</h3>
            <div class="small">ä¸å±•ç¤ºåˆ†æ®µ/å¬å›ç»†èŠ‚ï¼›ä»…æä¾›åˆ›å»ºã€ä¸Šä¼ ã€æŒ‚è½½ã€‚</div>
          </div>

          <div class="card">
            <h3>ç°æœ‰çŸ¥è¯†åº“</h3>
            <div class="row">
              <span class="chip">kb_demo</span>
              <span class="chip">product_docs</span>
              <span class="chip">policy_docs</span>
            </div>
            <div class="small" style="margin-top:10px">
              Agent é¡µå¯é€‰æ‹©æŒ‚è½½è¿™äº›çŸ¥è¯†åº“ï¼ˆDemoï¼‰ã€‚
            </div>
          </div>
        </div>

        <div class="kb-mid">
          <div class="card">
            <h3>åˆ›å»ºçŸ¥è¯†åº“ï¼ˆRAG Demoï¼‰</h3>

            <div class="field" style="margin-top:0">
              <label>çŸ¥è¯†åº“åç§°</label>
              <input id="kbName" value="kb_demo" />
            </div>

            <div class="field">
              <label>æè¿°</label>
              <input id="kbDesc" value="ç”¨äºæ¼”ç¤ºçš„çŸ¥è¯†åº“ï¼ˆå‰ç«¯æœ¬åœ°ï¼‰" />
            </div>

            <div class="sep"></div>

            <div class="drop" id="dropZone">
              <div><strong>ä¸Šä¼ èµ„æ–™</strong>ï¼ˆæ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©ï¼‰</div>
              <div class="small">æ”¯æŒ txt / md / pdf / docx / xlsx / å›¾ç‰‡ç­‰ï¼ˆDemo ä¸åšè§£æï¼Œä»…å±•ç¤ºæ–‡ä»¶åˆ—è¡¨ï¼‰ã€‚</div>
              <div class="row">
                <input type="file" id="kbFiles" multiple style="display:none" />
                <button class="btn primary" id="btnPickFiles">é€‰æ‹©æ–‡ä»¶</button>
                <button class="btn" id="btnClearFiles">æ¸…ç©ºæ–‡ä»¶</button>
              </div>
              <div class="filelist" id="fileList"></div>
            </div>

            <div class="row" style="margin-top:14px">
              <button class="btn primary" id="btnCreateKb">åˆ›å»º/ä¿å­˜çŸ¥è¯†åº“ï¼ˆDemoï¼‰</button>
              <button class="btn" id="btnBackToAgent">è¿”å› Agent ç¼–è¾‘</button>
            </div>

            <div class="help">
              è¯´æ˜ï¼šè¿™é‡Œä¸åšåˆ†æ®µå±•ç¤ºã€ä¸åšå‘é‡åŒ–/ç´¢å¼•ï¼ŒåªæŠŠä¸Šä¼ æ–‡ä»¶åˆ—å‡ºæ¥ï¼Œæ¨¡æ‹Ÿâ€œèµ„æ–™å·²åŠ å…¥çŸ¥è¯†åº“â€ã€‚
            </div>
          </div>
        </div>

        <div class="kb-right">
          <div class="card">
            <h3>æŒ‚è½½åˆ° Agentï¼ˆDemoï¼‰</h3>
            <div class="small">
              åˆ›å»º/ä¿å­˜åï¼Œä½ å¯ä»¥å›åˆ° Agent é¡µï¼Œåœ¨â€œçŸ¥è¯†â€é‡Œé€‰æ‹©è¯¥çŸ¥è¯†åº“å¹¶å¼€å¯æ£€ç´¢ã€‚
            </div>
            <div class="sep"></div>
            <div class="small" id="kbSummary">å½“å‰ï¼škb_demoï¼ˆ0 ä¸ªæ–‡ä»¶ï¼‰</div>
          </div>

          <div class="card">
            <h3>æ¨¡æ‹Ÿæ£€ç´¢ï¼ˆDemoï¼‰</h3>
            <div class="field" style="margin-top:0">
              <label>è¾“å…¥é—®é¢˜</label>
              <input id="kbQuery" placeholder="ä¾‹å¦‚ï¼šè¿™ä¸ªäº§å“çš„é€€æ¬¾è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ" />
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn green" id="btnKbSearch">æ£€ç´¢ï¼ˆDemoï¼‰</button>
            </div>
            <div class="log" id="kbLog" style="margin-top:10px; max-height: 220px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // Helpers
  // =========================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const esc = (s) => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  const uid = (p='id') => p + Math.random().toString(16).slice(2,10);

  // =========================
  // Global status / tabs
  // =========================
  const globalStatus = $('#globalStatus');
  let globalDirty = false;
  function setDirty(d){
    globalDirty = d;
    globalStatus.textContent = d ? 'æœªä¿å­˜ï¼ˆDemoï¼‰' : 'è‰ç¨¿å·²ä¿å­˜';
    globalStatus.style.borderColor = d ? 'rgba(245,158,11,.35)' : 'var(--line2)';
    globalStatus.style.color = d ? '#92400e' : 'var(--muted)';
  }
  setDirty(false);

  const pages = {
    agent: $('#page-agent'),
    workflow: $('#page-workflow'),
    kb: $('#page-kb'),
  };
  function setPage(key){
    Object.keys(pages).forEach(k => pages[k].classList.toggle('active', k===key));
    $$('#tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.page === key));
  }

  $('#tabs').addEventListener('click', (e) => {
    const t = e.target.closest('.tab');
    if(!t) return;
    setPage(t.dataset.page);
  });

  $('#btnReset').addEventListener('click', () => location.reload());
  $('#btnPublish').addEventListener('click', () => {
    setDirty(false);
    // small cross-page feedback
    wfToast('å‘å¸ƒæˆåŠŸï¼ˆDemoï¼‰');
    wfLog('å‘å¸ƒï¼šé€šè¿‡ï¼ˆDemoï¼‰');
  });

  // global run: run workflow (if workflow enabled in agent), else just simulate
  $('#btnRun').addEventListener('click', () => {
    const useWf = $('#useWorkflow').value === 'on';
    if(useWf){
      setPage('workflow');
      runWorkflow();
    }else{
      addMsg(`ï¼ˆDemoï¼‰æœªå¯ç”¨å·¥ä½œæµï¼šå½“å‰åªåšå¯¹è¯æ¨¡æ‹Ÿã€‚`, 'assistant');
    }
  });

  // =========================
  // Agent page
  // =========================
  const acc = $('#acc');
  acc.addEventListener('click', (e) => {
    const head = e.target.closest('.acc-head');
    if(!head) return;
    const item = head.closest('.acc-item');
    if(!item) return;

    const open = item.classList.contains('open');
    // toggle only clicked item
    item.classList.toggle('open', !open);
    item.querySelector('.chev').textContent = open ? 'â–¸' : 'â–¾';
  });

  // chips reflect selection
  const chipWorkflow = $('#chipWorkflow');
  const chipKb = $('#chipKb');
  const chipKbOn = $('#chipKbOn');

  function syncChips(){
    chipWorkflow.textContent = $('#workflowSelect').value;
    chipKb.textContent = $('#kbSelect').value;
    chipKbOn.textContent = $('#useKb').value.toUpperCase();
  }
  $('#workflowSelect').addEventListener('change', () => { syncChips(); setDirty(true); });
  $('#kbSelect').addEventListener('change', () => { syncChips(); setDirty(true); });
  $('#useKb').addEventListener('change', () => { syncChips(); setDirty(true); });
  $('#useWorkflow').addEventListener('change', () => { syncChips(); setDirty(true); });
  $('#agentSystem').addEventListener('input', () => setDirty(true));
  $('#agentToolPolicy').addEventListener('input', () => setDirty(true));
  $('#agentHello').addEventListener('input', () => setDirty(true));
  $('#agentModel').addEventListener('change', () => setDirty(true));
  $('#agentTemp').addEventListener('input', () => setDirty(true));
  syncChips();

  // open workflow/kb from agent
  $('#btnOpenWorkflowFromAgent').addEventListener('click', () => setPage('workflow'));
  $('#btnOpenKbFromAgent').addEventListener('click', () => setPage('kb'));

  // save agent
  $('#btnSaveAgent').addEventListener('click', () => {
    setDirty(false);
    addMsg('ï¼ˆç³»ç»Ÿï¼‰å·²ä¿å­˜ Agent é…ç½®ï¼ˆDemoï¼‰', 'assistant');
  });

  // Chat debug
  const chatBody = $('#chatBody');
  const chatInput = $('#chatInput');

  function addMsg(text, who='assistant'){
    const el = document.createElement('div');
    el.className = 'msg ' + (who==='user' ? 'user' : 'assistant');
    el.textContent = text;
    chatBody.appendChild(el);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function agentReply(userText){
    const model = $('#agentModel').value;
    const temp = $('#agentTemp').value;
    const useWf = $('#useWorkflow').value === 'on';
    const wfName = $('#workflowSelect').value;

    const useKb = $('#useKb').value === 'on';
    const kbName = $('#kbSelect').value;

    const sys = $('#agentSystem').value.trim();
    const policy = $('#agentToolPolicy').value.trim();

    // local deterministic demo reply
    const head = `ï¼ˆDemoï¼‰æ¨¡å‹ï¼š${model}  æ¸©åº¦ï¼š${temp}`;
    const sysHint = sys ? `ç³»ç»Ÿè§„åˆ™æ‘˜è¦ï¼š${sys.slice(0, 60)}${sys.length>60?'â€¦':''}` : 'æœªè®¾ç½®ç³»ç»Ÿè§„åˆ™';
    const toolHint = policy ? `å·¥å…·ç­–ç•¥æ‘˜è¦ï¼š${policy.slice(0, 60)}${policy.length>60?'â€¦':''}` : 'æœªè®¾ç½®å·¥å…·ç­–ç•¥';

    const wfLine = useWf ? `å·¥ä½œæµï¼šå·²å¯ç”¨ï¼ˆ${wfName}ï¼‰` : `å·¥ä½œæµï¼šæœªå¯ç”¨`;
    const kbLine = useKb ? `çŸ¥è¯†åº“ï¼šå·²å¯ç”¨æ£€ç´¢ï¼ˆ${kbName}ï¼‰` : `çŸ¥è¯†åº“ï¼šæœªå¯ç”¨`;

    let extra = '';
    // super simple routing: if message contains "æµç¨‹/å·¥ä½œæµ/ä¸‹å•" -> mention workflow, else mention KB if "èµ„æ–™/æ–‡æ¡£/è§„åˆ™"
    if(useWf && /æµç¨‹|å·¥ä½œæµ|ä¸‹å•|è®¢å•|æ‰§è¡Œ/.test(userText)) extra = `å»ºè®®ï¼šåˆ‡åˆ°â€œå·¥ä½œæµè®¾è®¡â€é¡µç‚¹â€œè¯•è¿è¡Œâ€ï¼ŒéªŒè¯é“¾è·¯ã€‚`;
    else if(useKb && /èµ„æ–™|æ–‡æ¡£|è§„åˆ™|æ”¿ç­–|è¯´æ˜|æ‰‹å†Œ|RAG|çŸ¥è¯†åº“/.test(userText)) extra = `å»ºè®®ï¼šåˆ°â€œçŸ¥è¯†åº“ï¼ˆRAGï¼‰â€é¡µä¸Šä¼ èµ„æ–™ï¼Œç„¶ååœ¨æ­¤å¼€å¯æ£€ç´¢ã€‚`;

    return `${head}\n${sysHint}\n${toolHint}\n${wfLine}\n${kbLine}\n\nä½ è¯´ï¼š${userText}\n${extra || 'ï¼ˆDemoï¼‰è¿™æ˜¯æœ¬åœ°æ¨¡æ‹Ÿå›å¤ã€‚'}`;
  }

  $('#btnSend').addEventListener('click', () => {
    const t = chatInput.value.trim();
    if(!t) return;
    chatInput.value = '';
    addMsg(t, 'user');
    setTimeout(() => addMsg(agentReply(t), 'assistant'), 220);
  });

  chatInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') $('#btnSend').click();
  });

  $('#btnClearChat').addEventListener('click', () => { chatBody.innerHTML = ''; });

  $('#btnSendHello').addEventListener('click', () => {
    const hello = $('#agentHello').value.trim() || 'ä½ å¥½ï¼';
    addMsg(hello, 'assistant');
  });

  $('#btnQuickRun').addEventListener('click', () => $('#btnRun').click());

  // seed
  addMsg('ï¼ˆDemoï¼‰åœ¨è¿™é‡Œè°ƒè¯•å¯¹è¯ï¼šå‘é€æ¶ˆæ¯åï¼Œä¼šæ ¹æ®â€œæ˜¯å¦å¯ç”¨å·¥ä½œæµ/çŸ¥è¯†åº“â€ç»™å‡ºæ¨¡æ‹Ÿå›å¤ã€‚', 'assistant');

  // =========================
  // Workflow page (nodes deletable + delete button)
  // =========================
  const wfCanvasWrap = $('#wfCanvasWrap');
  const wfWorld = $('#wfWorld');
  const wfNodesLayer = $('#wfNodesLayer');
  const wfEdgesSvg = $('#wfEdgesSvg');
  const wfPreviewPath = $('#wfPreviewPath');
  const wfZoomPct = $('#wfZoomPct');
  const wfToastEl = $('#wfToast');
  const wfRunLog = $('#wfRunLog');
  const wfInspectorBody = $('#wfInspectorBody');
  const wfSelId = $('#wfSelId');

  const wfState = {
    nodes: new Map(),
    edges: new Map(),
    selectedNodeId: null,
    scale: 1,
    panX: 0,
    panY: 0,
    draggingNodeId: null,
    dragOffset: {x:0,y:0},
    panning: false,
    panStart: {x:0,y:0, panX:0, panY:0},
    connecting: null, // {fromNodeId, fromPort}
    hoverPortEl: null,
    running: false,
  };

  function wfToast(msg){
    wfToastEl.textContent = msg;
    wfToastEl.classList.add('show');
    clearTimeout(wfToast._t);
    wfToast._t = setTimeout(() => wfToastEl.classList.remove('show'), 1400);
  }

  function wfLog(msg){
    const t = new Date();
    const ts = String(t.getHours()).padStart(2,'0') + ':' + String(t.getMinutes()).padStart(2,'0') + ':' + String(t.getSeconds()).padStart(2,'0');
    wfRunLog.textContent += `[${ts}] ${msg}\n`;
    wfRunLog.scrollTop = wfRunLog.scrollHeight;
  }

  function applyWfTransform(){
    wfWorld.style.transform = `translate(${wfState.panX}px, ${wfState.panY}px) scale(${wfState.scale})`;
    wfZoomPct.textContent = Math.round(wfState.scale*100) + '%';
    renderWfEdges();
  }

  function wfScreenToWorld(sx, sy){
    const rect = wfCanvasWrap.getBoundingClientRect();
    return { x: (sx - rect.left - wfState.panX)/wfState.scale, y: (sy - rect.top - wfState.panY)/wfState.scale };
  }

  function nodeDefaults(type){
    if(type==='start') return { title:'å¼€å§‹', inputs:[], outputs:[{name:'input', type:'str'}], data:{} };
    if(type==='end') return { title:'ç»“æŸ', inputs:[{name:'output', type:'str'}], outputs:[], data:{} };
    if(type==='wait') return { title:'time_wait', inputs:[{name:'in', type:'str'}], outputs:[{name:'out', type:'str'}], data:{ seconds: 1, message:'success' } };
    if(type==='llm') return { title:'å¤§æ¨¡å‹', inputs:[{name:'input', type:'str'}], outputs:[{name:'output', type:'str'}], data:{ model:'gpt-4.1-mini', temperature:0.7, prompt:'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ã€‚' } };
    return { title:'èŠ‚ç‚¹', inputs:[{name:'in', type:'str'}], outputs:[{name:'out', type:'str'}], data:{} };
  }

  function addWfNode(type, wx, wy){
    const id = uid('n');
    const def = nodeDefaults(type);
    const node = { id, type, title:def.title, x:wx, y:wy, inputs:def.inputs, outputs:def.outputs, data:def.data, status:'idle' };
    wfState.nodes.set(id, node);
    renderWfNode(node);
    setDirty(true);
    selectWfNode(id);
    return id;
  }

  function addWfEdge(fromNodeId, fromPortName, toNodeId, toPortName){
    if(fromNodeId === toNodeId){ wfToast('ä¸å…è®¸è¿æ¥åˆ°è‡ªèº«ï¼ˆDemoï¼‰'); return null; }

    for(const e of wfState.edges.values()){
      if(e.from.nodeId===fromNodeId && e.from.port===fromPortName && e.to.nodeId===toNodeId && e.to.port===toPortName){
        wfToast('å·²å­˜åœ¨ç›¸åŒè¿çº¿');
        return null;
      }
    }

    const id = uid('e');
    wfState.edges.set(id, { id, from:{nodeId:fromNodeId, port:fromPortName}, to:{nodeId:toNodeId, port:toPortName} });
    renderWfEdges();
    setDirty(true);
    return id;
  }

  function removeWfNode(nodeId){
    for(const [eid, e] of [...wfState.edges.entries()]){
      if(e.from.nodeId===nodeId || e.to.nodeId===nodeId) wfState.edges.delete(eid);
    }
    wfState.nodes.delete(nodeId);
    const el = document.querySelector(`.node[data-wf-id="${nodeId}"]`);
    if(el) el.remove();
    if(wfState.selectedNodeId===nodeId) selectWfNode(null);
    renderWfEdges();
    setDirty(true);
    wfLog(`åˆ é™¤èŠ‚ç‚¹ï¼š${nodeId}`);
  }

  function renderWfNode(node){
    let el = document.querySelector(`.node[data-wf-id="${node.id}"]`);
    if(!el){
      el = document.createElement('div');
      el.className = 'node';
      el.dataset.wfId = node.id;

      el.innerHTML = `
        <div class="node-header">
          <div class="node-title">
            <span class="badge">${esc(node.type)}</span>
            <span class="title-text">${esc(node.title)}</span>
          </div>
          <div class="node-actions">
            <span class="run-badge" data-role="status">idle</span>
            <button class="iconbtn danger" data-act="delete" title="åˆ é™¤èŠ‚ç‚¹">ğŸ—‘</button>
          </div>
        </div>
        <div class="node-body">
          <div class="io-col" data-role="in"></div>
          <div class="io-col" data-role="out"></div>
        </div>
      `;

      wfNodesLayer.appendChild(el);

      // delete btn
      el.querySelector('[data-act="delete"]').addEventListener('click', (ev) => {
        ev.stopPropagation();
        removeWfNode(node.id);
      });

      // select + drag (avoid port/btn)
      el.addEventListener('mousedown', (ev) => {
        if(ev.button !== 0) return;
        const t = ev.target;
        if(t && t.classList && t.classList.contains('port')) return;
        if(t && t.closest && t.closest('[data-act="delete"]')) return;

        selectWfNode(node.id);
        const w = wfScreenToWorld(ev.clientX, ev.clientY);
        wfState.draggingNodeId = node.id;
        wfState.dragOffset.x = w.x - node.x;
        wfState.dragOffset.y = w.y - node.y;
        ev.stopPropagation();
      });

      el.addEventListener('dragstart', (e)=>e.preventDefault());
    }

    el.style.left = node.x + 'px';
    el.style.top  = node.y + 'px';
    el.querySelector('.title-text').textContent = node.title;
    el.querySelector('.badge').textContent = node.type;

    const statusEl = el.querySelector('[data-role="status"]');
    statusEl.textContent = node.status;
    statusEl.className = 'run-badge ' + (node.status==='running'?'running':node.status==='success'?'success':node.status==='error'?'error':'');

    const inCol = el.querySelector('[data-role="in"]');
    const outCol = el.querySelector('[data-role="out"]');
    inCol.innerHTML = '';
    outCol.innerHTML = '';

    const mkRow = (kind, port) => {
      const row = document.createElement('div');
      row.className = 'io-pill';
      row.innerHTML = `
        <span style="display:flex;align-items:center;gap:8px;">
          ${kind==='in' ? `<span class="port in" data-kind="in" data-port="${esc(port.name)}"></span>` : ''}
          <span>${esc(port.type)}: ${esc(port.name)}</span>
          ${kind==='out' ? `<span class="port out" data-kind="out" data-port="${esc(port.name)}"></span>` : ''}
        </span>
      `;
      const portEl = row.querySelector('.port');
      if(portEl){
        portEl.addEventListener('mousedown', (ev) => {
          ev.stopPropagation();
          if(ev.button !== 0) return;
          if(portEl.dataset.kind !== 'out') return;

          selectWfNode(node.id);
          wfState.connecting = { fromNodeId: node.id, fromPort: portEl.dataset.port };
          renderWfPreview(ev.clientX, ev.clientY);
        });

        portEl.addEventListener('mouseenter', () => {
          if(wfState.connecting && portEl.dataset.kind === 'in'){
            portEl.classList.add('hit');
            wfState.hoverPortEl = portEl;
          }
        });
        portEl.addEventListener('mouseleave', () => {
          portEl.classList.remove('hit');
          if(wfState.hoverPortEl === portEl) wfState.hoverPortEl = null;
        });

        portEl.addEventListener('mouseup', (ev) => {
          if(!wfState.connecting) return;
          if(portEl.dataset.kind !== 'in') return;
          ev.stopPropagation();

          const toNodeId = node.id;
          const toPort = portEl.dataset.port;

          // type check (simple)
          const fromNode = wfState.nodes.get(wfState.connecting.fromNodeId);
          const outPort = (fromNode.outputs||[]).find(p => p.name === wfState.connecting.fromPort);
          const inPort = (node.inputs||[]).find(p => p.name === toPort);
          if(outPort && inPort && outPort.type !== inPort.type){
            wfToast(`ç±»å‹ä¸åŒ¹é…ï¼š${outPort.type} â†’ ${inPort.type}`);
            cancelWfConnect();
            return;
          }

          addWfEdge(wfState.connecting.fromNodeId, wfState.connecting.fromPort, toNodeId, toPort);
          cancelWfConnect();
        });
      }
      return row;
    };

    const inLabel = document.createElement('div');
    inLabel.className = 'io-label';
    inLabel.innerHTML = `<span>è¾“å…¥</span><span class="kbd">${(node.inputs||[]).length}</span>`;
    inCol.appendChild(inLabel);
    (node.inputs||[]).forEach(p => inCol.appendChild(mkRow('in', p)));

    const outLabel = document.createElement('div');
    outLabel.className = 'io-label';
    outLabel.innerHTML = `<span>è¾“å‡º</span><span class="kbd">${(node.outputs||[]).length}</span>`;
    outCol.appendChild(outLabel);
    (node.outputs||[]).forEach(p => outCol.appendChild(mkRow('out', p)));
  }

  function clearWfEdges(){
    [...wfEdgesSvg.querySelectorAll('path')].filter(p => p.id !== 'wfPreviewPath').forEach(p => p.remove());
  }

  function getWfPortWorldPos(nodeId, portKind, portName){
    const nodeEl = document.querySelector(`.node[data-wf-id="${nodeId}"]`);
    if(!nodeEl) return null;
    const portEl = nodeEl.querySelector(`.port.${portKind}[data-port="${CSS.escape(portName)}"]`);
    if(!portEl) return null;
    const r = portEl.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    return wfScreenToWorld(cx, cy);
  }

  function cubicPath(x1,y1,x2,y2){
    const dx = Math.max(60, Math.abs(x2-x1)*0.35);
    const c1x = x1 + dx, c1y = y1;
    const c2x = x2 - dx, c2y = y2;
    return `M ${x1} ${y1} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${x2} ${y2}`;
  }

  function renderWfEdges(){
    clearWfEdges();
    for(const e of wfState.edges.values()){
      const a = getWfPortWorldPos(e.from.nodeId, 'out', e.from.port);
      const b = getWfPortWorldPos(e.to.nodeId, 'in', e.to.port);
      if(!a || !b) continue;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('class','edge-path ok');
      path.setAttribute('d', cubicPath(a.x, a.y, b.x, b.y));
      wfEdgesSvg.appendChild(path);
    }
  }

  function renderWfPreview(screenX, screenY){
    if(!wfState.connecting){ wfPreviewPath.setAttribute('d',''); return; }
    const from = getWfPortWorldPos(wfState.connecting.fromNodeId, 'out', wfState.connecting.fromPort);
    if(!from){ wfPreviewPath.setAttribute('d',''); return; }
    const to = wfScreenToWorld(screenX, screenY);
    wfPreviewPath.setAttribute('d', cubicPath(from.x, from.y, to.x, to.y));
  }

  function cancelWfConnect(){
    wfState.connecting = null;
    wfPreviewPath.setAttribute('d','');
    if(wfState.hoverPortEl){
      wfState.hoverPortEl.classList.remove('hit');
      wfState.hoverPortEl = null;
    }
  }

  function selectWfNode(nodeId){
    wfState.selectedNodeId = nodeId;
    document.querySelectorAll('.node[data-wf-id]').forEach(el => el.classList.toggle('selected', el.dataset.wfId === nodeId));

    if(!nodeId){
      wfSelId.textContent = 'æœªé€‰ä¸­';
      wfInspectorBody.textContent = 'ç‚¹å‡»ç”»å¸ƒèŠ‚ç‚¹æŸ¥çœ‹/ç¼–è¾‘å‚æ•°ã€‚';
      return;
    }
    wfSelId.textContent = nodeId;
    const node = wfState.nodes.get(nodeId);
    wfInspectorBody.innerHTML = buildWfInspector(node);
    wireWfInspector(node);
  }

  function buildWfInspector(node){
    const common = `
      <div class="field" style="margin-top:10px">
        <label>èŠ‚ç‚¹æ ‡é¢˜</label>
        <input id="wf_f_title" value="${esc(node.title)}" />
      </div>
      <div class="field">
        <label>èŠ‚ç‚¹ç±»å‹</label>
        <input value="${esc(node.type)}" disabled />
      </div>
    `;
    if(node.type === 'wait'){
      return `
        <div class="small"><span class="pill">å»¶æ—¶èŠ‚ç‚¹å‚æ•°</span></div>
        ${common}
        <div class="field">
          <label>seconds</label>
          <input id="wf_f_seconds" type="number" min="0" step="1" value="${esc(String(node.data.seconds ?? 1))}" />
        </div>
        <div class="field">
          <label>message</label>
          <input id="wf_f_message" value="${esc(node.data.message ?? 'success')}" />
        </div>
      `;
    }
    if(node.type === 'llm'){
      return `
        <div class="small"><span class="pill">å¤§æ¨¡å‹èŠ‚ç‚¹å‚æ•°ï¼ˆDemoï¼‰</span></div>
        ${common}
        <div class="field">
          <label>model</label>
          <select id="wf_f_model">
            ${['gpt-4.1-mini','gpt-4.1','gpt-4o-mini','gpt-4o'].map(m => `
              <option value="${esc(m)}" ${node.data.model===m?'selected':''}>${esc(m)}</option>
            `).join('')}
          </select>
        </div>
        <div class="field">
          <label>temperature</label>
          <input id="wf_f_temp" type="number" min="0" max="2" step="0.1" value="${esc(String(node.data.temperature ?? 0.7))}" />
        </div>
        <div class="field">
          <label>prompt</label>
          <textarea id="wf_f_prompt" style="min-height:90px">${esc(node.data.prompt ?? '')}</textarea>
        </div>
      `;
    }
    return `
      <div class="small"><span class="pill">é€šç”¨èŠ‚ç‚¹å‚æ•°</span></div>
      ${common}
      <div class="field">
        <label>å¤‡æ³¨ï¼ˆDemoï¼‰</label>
        <textarea id="wf_f_note" style="min-height:90px">${esc(node.data.note ?? '')}</textarea>
      </div>
    `;
  }

  function wireWfInspector(node){
    const title = $('#wf_f_title');
    if(title){
      title.addEventListener('input', () => {
        node.title = title.value.trim() || node.title;
        renderWfNode(node);
        renderWfEdges();
        setDirty(true);
      });
    }
    if(node.type==='wait'){
      const sec = $('#wf_f_seconds');
      const msg = $('#wf_f_message');
      if(sec) sec.addEventListener('input', () => { node.data.seconds = Math.max(0, parseInt(sec.value||'0',10)); setDirty(true); });
      if(msg) msg.addEventListener('input', () => { node.data.message = msg.value; setDirty(true); });
    }
    if(node.type==='llm'){
      const model = $('#wf_f_model');
      const temp = $('#wf_f_temp');
      const prompt = $('#wf_f_prompt');
      if(model) model.addEventListener('change', () => { node.data.model = model.value; setDirty(true); });
      if(temp) temp.addEventListener('input', () => { node.data.temperature = parseFloat(temp.value||'0.7'); setDirty(true); });
      if(prompt) prompt.addEventListener('input', () => { node.data.prompt = prompt.value; setDirty(true); });
    }
    const note = $('#wf_f_note');
    if(note) note.addEventListener('input', () => { node.data.note = note.value; setDirty(true); });
  }

  // palette drag
  $$('#wfPalette .node-item[draggable="true"]').forEach(item => {
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', item.dataset.type);
      e.dataTransfer.effectAllowed = 'copy';
    });
  });

  wfCanvasWrap.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect='copy'; });
  wfCanvasWrap.addEventListener('drop', (e) => {
    e.preventDefault();
    const type = e.dataTransfer.getData('text/plain');
    if(!type) return;
    const w = wfScreenToWorld(e.clientX, e.clientY);
    addWfNode(type, w.x - 115, w.y - 45);
    wfToast(`å·²æ·»åŠ èŠ‚ç‚¹ï¼š${type}`);
  });

  // canvas interactions
  wfCanvasWrap.addEventListener('mousedown', (ev) => {
    if(ev.button !== 0) return;
    if(ev.target === wfCanvasWrap || ev.target === wfWorld || ev.target === wfNodesLayer || ev.target === wfEdgesSvg){
      wfState.panning = true;
      wfState.panStart.x = ev.clientX;
      wfState.panStart.y = ev.clientY;
      wfState.panStart.panX = wfState.panX;
      wfState.panStart.panY = wfState.panY;
      selectWfNode(null);
    }
  });

  window.addEventListener('mousemove', (ev) => {
    if(wfState.draggingNodeId){
      const node = wfState.nodes.get(wfState.draggingNodeId);
      if(node){
        const w = wfScreenToWorld(ev.clientX, ev.clientY);
        node.x = w.x - wfState.dragOffset.x;
        node.y = w.y - wfState.dragOffset.y;
        renderWfNode(node);
        renderWfEdges();
        setDirty(true);
      }
      return;
    }
    if(wfState.panning){
      const dx = ev.clientX - wfState.panStart.x;
      const dy = ev.clientY - wfState.panStart.y;
      wfState.panX = wfState.panStart.panX + dx;
      wfState.panY = wfState.panStart.panY + dy;
      applyWfTransform();
      return;
    }
    if(wfState.connecting){
      renderWfPreview(ev.clientX, ev.clientY);
    }
  });

  window.addEventListener('mouseup', () => {
    if(wfState.draggingNodeId){ wfState.draggingNodeId=null; return; }
    if(wfState.panning){ wfState.panning=false; return; }
    if(wfState.connecting){ cancelWfConnect(); }
  });

  wfCanvasWrap.addEventListener('wheel', (ev) => {
    ev.preventDefault();
    const delta = -ev.deltaY;
    const factor = delta > 0 ? 1.08 : 1/1.08;

    const before = wfScreenToWorld(ev.clientX, ev.clientY);
    const newScale = clamp(wfState.scale * factor, 0.35, 2.5);

    const rect = wfCanvasWrap.getBoundingClientRect();
    const sx = ev.clientX - rect.left;
    const sy = ev.clientY - rect.top;

    wfState.scale = newScale;
    wfState.panX = sx - before.x * newScale;
    wfState.panY = sy - before.y * newScale;
    applyWfTransform();
  }, {passive:false});

  wfCanvasWrap.addEventListener('click', (ev) => {
    if(ev.target === wfCanvasWrap || ev.target === wfWorld || ev.target === wfNodesLayer || ev.target === wfEdgesSvg){
      selectWfNode(null);
      cancelWfConnect();
    }
  });

  // workflow buttons
  $('#wfZoomIn').addEventListener('click', () => { wfState.scale = clamp(wfState.scale*1.12, 0.35, 2.5); applyWfTransform(); });
  $('#wfZoomOut').addEventListener('click', () => { wfState.scale = clamp(wfState.scale/1.12, 0.35, 2.5); applyWfTransform(); });
  $('#wfFit').addEventListener('click', () => { wfState.scale=1; wfState.panX=0; wfState.panY=0; applyWfTransform(); wfToast('å·²é€‚é…è§†å›¾ï¼ˆé‡ç½®ï¼‰'); });
  $('#wfAddNode').addEventListener('click', () => {
    const rect = wfCanvasWrap.getBoundingClientRect();
    const w = wfScreenToWorld(rect.left + rect.width/2, rect.top + rect.height/2);
    addWfNode('llm', w.x - 115, w.y - 45);
    wfToast('å·²æ·»åŠ ä¸€ä¸ªâ€œå¤§æ¨¡å‹â€èŠ‚ç‚¹');
  });

  // delete key
  window.addEventListener('keydown', (ev) => {
    if(ev.key === 'Escape') cancelWfConnect();
    if(ev.key === 'Delete' || ev.key === 'Backspace'){
      const tag = document.activeElement && document.activeElement.tagName;
      if(tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
      if(wfState.selectedNodeId){
        removeWfNode(wfState.selectedNodeId);
        wfToast('å·²åˆ é™¤èŠ‚ç‚¹');
      }
    }
  });

  // workflow run
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function runWorkflow(){
    if(wfState.running) return;
    wfState.running = true;

    // reset
    for(const n of wfState.nodes.values()){ n.status='idle'; renderWfNode(n); }
    renderWfEdges();
    wfLog('è¯•è¿è¡Œï¼šå¼€å§‹');

    const start = [...wfState.nodes.values()].find(n => n.type==='start');
    if(!start){
      wfToast('ç¼ºå°‘å¼€å§‹èŠ‚ç‚¹');
      wfState.running=false;
      return;
    }

    const nextOf = (nodeId) => {
      for(const e of wfState.edges.values()){
        if(e.from.nodeId === nodeId) return e.to.nodeId;
      }
      return null;
    };

    let current = start.id;
    const visited = new Set();
    while(current){
      if(visited.has(current)){
        wfToast('æ£€æµ‹åˆ°å¾ªç¯ï¼ˆDemoï¼‰');
        wfLog('è¯•è¿è¡Œï¼šæ£€æµ‹åˆ°å¾ªç¯ï¼Œåœæ­¢');
        break;
      }
      visited.add(current);

      const node = wfState.nodes.get(current);
      if(!node) break;

      node.status='running';
      renderWfNode(node);
      selectWfNode(node.id);
      wfLog(`æ‰§è¡ŒèŠ‚ç‚¹ï¼š${node.title} (${node.type})`);

      let delayMs = 420;
      if(node.type==='wait') delayMs = Math.max(0, (node.data.seconds ?? 1) * 450);
      if(node.type==='llm') delayMs = 900;

      await sleep(delayMs);

      node.status='success';
      renderWfNode(node);

      current = nextOf(node.id);
    }

    wfLog('è¯•è¿è¡Œï¼šç»“æŸ');
    wfState.running=false;

    // after running, return to agent debug if you want
    // (keep as is; user can switch tabs)
  }

  // init workflow graph
  function initWorkflow(){
    // clear
    wfState.nodes.clear();
    wfState.edges.clear();
    wfNodesLayer.innerHTML = '';
    wfRunLog.textContent = '';

    const startId = addWfNode('start', 180, 220);
    const waitId  = addWfNode('wait', 470, 200);
    const llmId   = addWfNode('llm', 780, 200);
    const endId   = addWfNode('end', 1100, 220);

    addWfEdge(startId,'input', waitId,'in');
    addWfEdge(waitId,'out', llmId,'input');
    addWfEdge(llmId,'output', endId,'output');

    setDirty(false);
    selectWfNode(llmId);

    wfState.scale=1; wfState.panX=0; wfState.panY=0;
    applyWfTransform();

    wfLog('Demo å·²åˆå§‹åŒ–ï¼šå¼€å§‹ â†’ time_wait â†’ å¤§æ¨¡å‹ â†’ ç»“æŸ');
  }
  initWorkflow();

  // =========================
  // Knowledge base page (upload + simple list + mock search)
  // =========================
  const dropZone = $('#dropZone');
  const kbFilesInput = $('#kbFiles');
  const fileList = $('#fileList');
  const kbSummary = $('#kbSummary');
  const kbLog = $('#kbLog');

  let kbFiles = []; // File objects (in-memory)

  function fmtBytes(bytes){
    if(bytes < 1024) return bytes + ' B';
    const kb = bytes/1024;
    if(kb < 1024) return kb.toFixed(1) + ' KB';
    const mb = kb/1024;
    return mb.toFixed(1) + ' MB';
  }

  function renderFiles(){
    const name = $('#kbName').value.trim() || 'kb_demo';
    kbSummary.textContent = `å½“å‰ï¼š${name}ï¼ˆ${kbFiles.length} ä¸ªæ–‡ä»¶ï¼‰`;

    fileList.innerHTML = kbFiles.length ? '' : `<div class="small">å°šæœªä¸Šä¼ æ–‡ä»¶</div>`;
    kbFiles.forEach((f, idx) => {
      const el = document.createElement('div');
      el.className = 'fileitem';
      el.innerHTML = `
        <div class="filemeta">
          <div class="n">${esc(f.name)}</div>
          <div class="d">${esc(f.type || 'unknown')} Â· ${esc(fmtBytes(f.size))}</div>
        </div>
        <button class="btn ghost" data-idx="${idx}" title="ç§»é™¤">ç§»é™¤</button>
      `;
      el.querySelector('button').addEventListener('click', () => {
        kbFiles.splice(idx, 1);
        renderFiles();
        setDirty(true);
      });
      fileList.appendChild(el);
    });
  }

  function addFiles(list){
    const arr = [...list];
    // naive de-dup by name+size
    for(const f of arr){
      if(kbFiles.some(x => x.name===f.name && x.size===f.size)) continue;
      kbFiles.push(f);
    }
    renderFiles();
    setDirty(true);
  }

  $('#btnPickFiles').addEventListener('click', () => kbFilesInput.click());
  kbFilesInput.addEventListener('change', () => {
    if(kbFilesInput.files && kbFilesInput.files.length) addFiles(kbFilesInput.files);
    kbFilesInput.value = '';
  });

  $('#btnClearFiles').addEventListener('click', () => {
    kbFiles = [];
    renderFiles();
    setDirty(true);
  });

  // drag/drop
  ;['dragenter','dragover'].forEach(evt => dropZone.addEventListener(evt, (e) => {
    e.preventDefault();
    dropZone.style.background = 'rgba(91,92,246,.07)';
  }));
  ;['dragleave','drop'].forEach(evt => dropZone.addEventListener(evt, (e) => {
    e.preventDefault();
    dropZone.style.background = 'rgba(91,92,246,.04)';
  }));

  dropZone.addEventListener('drop', (e) => {
    if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
      addFiles(e.dataTransfer.files);
    }
  });

  $('#kbName').addEventListener('input', () => { renderFiles(); setDirty(true); });
  $('#kbDesc').addEventListener('input', () => setDirty(true));

  $('#btnCreateKb').addEventListener('click', () => {
    setDirty(false);
    const name = $('#kbName').value.trim() || 'kb_demo';
    kbLog.textContent += `å·²ä¿å­˜çŸ¥è¯†åº“ï¼š${name}ï¼ˆæ–‡ä»¶æ•°ï¼š${kbFiles.length}ï¼‰\n`;
    kbLog.scrollTop = kbLog.scrollHeight;

    // also sync agent KB select if same name exists? keep simple:
    // if user created a new name, inject into agent selector (demo)
    const sel = $('#kbSelect');
    if(![...sel.options].some(o => o.value === name)){
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.insertBefore(opt, sel.firstChild);
      sel.value = name;
      syncChips();
    }
  });

  $('#btnBackToAgent').addEventListener('click', () => setPage('agent'));

  $('#btnKbSearch').addEventListener('click', () => {
    const q = ($('#kbQuery').value || '').trim();
    if(!q){
      kbLog.textContent += `è¯·è¾“å…¥é—®é¢˜åå†æ£€ç´¢ï¼ˆDemoï¼‰ã€‚\n`;
      kbLog.scrollTop = kbLog.scrollHeight;
      return;
    }
    const name = $('#kbName').value.trim() || 'kb_demo';
    const hit = kbFiles.length ? kbFiles[Math.floor(Math.random()*kbFiles.length)].name : '(æ— æ–‡ä»¶)';
    kbLog.textContent += `æ£€ç´¢ï¼š${q}\nå‘½ä¸­ï¼š${hit}\nï¼ˆDemoï¼‰è¿”å›ï¼šåŸºäº ${name} çš„æ¨¡æ‹Ÿæ‘˜è¦ã€‚\n\n`;
    kbLog.scrollTop = kbLog.scrollHeight;
  });

  renderFiles();

  // =========================
  // Cross links
  // =========================
  $('#btnOpenWorkflowFromAgent').addEventListener('click', () => setPage('workflow'));
  $('#btnOpenKbFromAgent').addEventListener('click', () => setPage('kb'));

  // When KB selection changes on agent, keep chips updated
  function syncChips(){
    $('#chipWorkflow').textContent = $('#workflowSelect').value;
    $('#chipKb').textContent = $('#kbSelect').value;
    $('#chipKbOn').textContent = $('#useKb').value.toUpperCase();
  }

})();
</script>
</body>
</html>
